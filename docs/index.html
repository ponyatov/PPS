<html>
<link rel="manifest" href="/manifest.json">

<link rel="icon" type="image/png" href="planning.png" />
<meta name="theme-color" content="black">

<title>PPS/js</title>

<style>
* {
	border-style: solid; border-color: green; border-width: thin;
	font-family: monospace, monospace; font-size: 2vh;
	background: black; color: lightgreen;
}

html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; }

textarea,button { width: 100%; }

textarea { caret-color: red; caret-style: block; }

.input_strips { font-size: 30px; }

#cmd { position: absolute; bottom: 0; width: 100%; margin: 0; max-height: 30%; }

#go { background: darkslategray; height: 11vmin; border-width: thick; }

#meta { color: cyan; font-size: 2vh; }

#swipe {
	height: 77%; overflow-x: scroll; overflow-y: scroll;
	white-space: nowrap; 
}

#swipe * {
	display: inline-block; vertical-align: top; max-width: 88%; border: double; 
}

#log * { border: none; }

</style>

<div id=swipe>
<pre id=log># log

 <img src="android_plan.png"/> Welcome

 This PPS/js system is a 
 JavaScript/HTML implementation of a
 <a href="https://ponyatov.quora.com/On-computer-language-design-PPS-Personal-Planning-System-platform">Personal Planning System</a> prototype
 extended with <a href="https://ponyatov.quora.com/On-computer-language-design-metaprogramming-1">metaprogramming</a> features. 

 To understand the overall idea
 first look this <a href="http://www.google.com/url?q=http%3A%2F%2Fwww.bayfronttechnologies.com%2Fmc_workshop.html&sa=D&sntz=1&usg=AFQjCNF-KH1P-tQqIjhb2C0f7Fl1jCivKg">METAII workshop</a>:
 it is an online implementation of a
 METAII metacompiler (by) D.V. Schorre
 
 Here I implemented tiny draft with a
 feel of METAII workshop described above.
 But it uses <a href="http://pegjs.org">PEG.js parser generator</a>
 works in your browser as a js library,
 so you have full control over syntax
 and semantics right in your hands.
 
 <h1>How to use it</h1>
 
 If you scroll this page now to right,
 you'll see the cyan-colored window
 with PEG grammar of some FORTH-like
 script mixed with JavaScript code
 will be executed on every rule match
   
</pre>

<pre id=stack># stack</pre>
<pre id=words># words</pre>

<textarea id=meta oninput='swipe_upd()'>// PEG grammar

{ log.innerText = "you can run any JS code before PEG starts\n\n" }

FORTH "metacompiler"
  = ( ( comment
    / num:ber   { out(num)  }
    / word:name { out(word) }
    ) _ ) *

ber
  = pfx:'0x' hex:[0-9a-fA-F]+
    { return 'hex:'+pfx+join(hex) }
  / pfx:'0b' bin:[01]+
    { return 'bin:'+pfx+join(bin) }
  / num:([0-9]+[.][0-9]*)
    { return 'num:'+join(num) }
  / exp:([0-9]+[eE][+\-]?[0-9]+)
    { return 'exp:'+join(exp) }
  / int:[0-9]+
    { return 'int:'+join(int) }
    
name
  = token:[a-zA-Z0-9_]+
    { return join(token) }
  / op:[()+*]
    { return 'op:'+op }

comment
  = '#'[^\n]* { return "" }

_ "whitespace"
  = [ \t\n\r]*

</textarea>

</div>

<div id=cmd>

<textarea id=pad rows=5># console
22 * (3 + 4)
1 2.3 4e-5 0xDeadBeef 0b1101
</textarea>

<button id=go onclick="gocmd()">GO</button>
</div>


<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-auth.js"></script>
<!--script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-database.js"></script-->
<!--script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-firestore.js"></script-->
<!--script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-messaging.js"></script-->
<!--script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-functions.js"></script-->
<script>
  // Initialize Firebase
  var firebase_config = {
    apiKey: "AIzaSyAmUfAweE5EM6L-mpMFmo8jOJp1yb7zKWE",
    authDomain: "leafy-oxide-211212.firebaseapp.com",
    databaseURL: "https://leafy-oxide-211212.firebaseio.com",
    projectId: "leafy-oxide-211212",
    storageBucket: "leafy-oxide-211212.appspot.com",
    messagingSenderId: "475478214606"
  };
  firebase.initializeApp(firebase_config);
</script>

<script src="PEG.js"></script>
<script>

function gocmd() { INTERPRET(pad.value) }

function clr()  { log.innerText = '' }
function out(str) { log.innerText += str+'\n' }
function join(dat) { return dat.join("") }

function errlog(e) {
	S = 'error:\n'
	JSON.stringify(e).match(/.{1,40}/g).forEach(function(item,i,arr) {
		S += item + '\n'
	})
	return S 
}

function INTERPRET(SRC) {
	clr();
	sessionStorage[Date()] = SRC
	try { peg.generate(meta.value).parse(pad.value)	}
	catch(e) { log.innerText += errlog(e) }
	
}

function head(obj) { return "<"+obj.type+":"+obj.value+">"; }
function dump(obj) { return head(obj); }

function Sym(T,V) {
	return {type:T, value:V, attr:{}, nest:[], dump:dump }
}

function Stack(name) { return Sym('stack',name); }
function Voc(name)   { return Sym('voc',name);   }

var S = Stack('data') 

var W = Voc('global')

function swipe_upd() {
	//meta.style.width  = meta.scrollWidth +1 + "px"
	meta.style.height = meta.scrollHeight + "px"
}

function update() {
	stack.innerText = S.dump(S)
	words.innerText = W.dump(W)
	swipe_upd()
}

function keydown(event) {
	if (event.ctrlKey & event.key == 'Enter') gocmd()
}

window.onload = function() {
	document.body.onkeydown = keydown
	if (navigator.onLine) online(); else offline(); // fix on reload
	update();
}

function offline() { go.style.borderColor = "darkred" }
window.onoffline = offline

function  online() { go.style.borderColor = "green"   }
window.ononline  = online

</script>
