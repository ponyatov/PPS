<title>VM/js</title>

<link rel="icon" type="image/png" href="triangle.png">

<style>

* {
	background: black; color: lightgreen;
	font-family: monospace, monospace; font-size: 2vh;
	margin:0;
}

textarea,button { width:100%; }
textarea { caret-color: red; } 
button { background: darkslategray; height: 7vmin; }

#stack,#pad { color:cyan; }

#cmd { position: absolute; bottom:0; width:100%; }

</style>

<pre id=log>Hello
</pre>

<pre id=stack>stack:</pre>

<div id=cmd>

<textarea id=meta rows=11>// PEG grammar

{ out('Hello') } // init code runs first

FORTH
  = (( comment 
  / n:number { out(n) }
  / w:word   { out(w) }
  ) _ ) *

comment = [#\\][^\n]*
_       = [ \t\r\n]*

number
  = '0x' hex:[0-9a-fA-F]+
    { return join(hex) }
  / '0b' bin:[01]+
    { return join(bin) }
  / pfx:[\+\-]?
    int:[0-9]+
    flo:('.' flo:[0-9]* { return flo } )?
    exp:([eE][\+\-]?[0-9]+)?
      { return num(pfx,int,flo,exp) }

word
  = w:[a-zA-Z0-9_.\+\-]+
    { out(join(w)) }

</textarea>

<textarea id=pad rows=5># command

-01 +02.30 +4e-5 0xDeadBeef 0b1101 \ numbers

</textarea>

<button id=go onclick="go()">GO</button>
</div>

<script src=PEG.js></script>
<script>

function join(dat) { return dat.join("") }

function num(pfx,int,flo,exp) {
	S = ''
	if (pfx) S += pfx
	S += join(int)
	if (flo) S += '.'+join(flo)
	if (exp) S += join(exp)
	return S
}

function wrap(some) {
	var S = '' 
	JSON.stringify(some)
		.match(/.{1,44}/g)
		.forEach(function(item,i,arr) {
			S += item + '\n'})
	return S	
}

function out(some) { log.innerText += wrap(some) }

function go() {
	log.innerText = ''
	try { peg.generate(meta.value).parse(pad.value) }
	catch(e) { log.innerText = "error:\n" + out(e) }
	update()
}

function keydown(event) {
	if (event.ctrlKey & event.key == 'Enter') go()
}

window.onload = function() {
	document.body.onkeydown = keydown
	update()
}

S = []	// data stack

function push(obj) { S.push(obj) }

function update() {
	stack.innerText = wrap('stack:' + JSON.stringify(S))
}

</script>
