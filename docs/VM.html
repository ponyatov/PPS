<title>VM/js</title>
<link rel="manifest" href="/VM.json">
<meta name="theme-color" content="black">
<link rel="icon" type="image/png" href="triangle.png">

<style>

* {
	background: black; color: lightgreen;
	font-family: monospace, monospace; font-size: 2vh;
	margin:0;
}

textarea,button { width:100%; font-family: inherit;font-size: inherit; }
textarea { caret-color: red; }
button { background: darkslategray; height: 11vmin; }

#stack,#pad { color:cyan; }

#cmd { position: absolute; bottom:0; width:100%; }

#topswipe {
	height:66%; overflow: scroll; white-space: nowrap; }

#cmdswipe {
	height:44%; overflow: scroll; white-space: nowrap; }

#topswipe * {
	border:solid;
	display: inline-block; vertical-align: top; max-width: 88%; }

.swipe * {
	border:solid;
	display: inline-block; vertical-align: top;
	min-width: 11%; min-height: 11%; 
	max-width: 95%; }
	
</style>

<div id=topswipe class=swipe>

<pre id=log>Hello
</pre>

<pre id=stack>stack:</pre>

</div>

<div id=cmd>

<div id=cmdswipe class=swipe>

<textarea id=meta rows=11>// PEG grammar

// init code runs first
{ out('Hello') }

FORTH
  = (( comment 
  / n:number { out(n) }
  / w:word   { out(w) }
  ) _ ) *

comment = [#\\][^\n]*
_       = [ \t\r\n]*

number
  = '0x' hex:[0-9a-fA-F]+
    { return new Hex(join(hex)) }
  / '0b' bin:[01]+
    { return new Bin(join(bin)) }
  / s:[\+\-]?
    n:[0-9]+
    f:('.' flo:[0-9]*
      { return flo } )?
    e:([eE][\+\-]?[0-9]+)?
      { return num(s,n,f,e) }

word
  = w:[a-zA-Z0-9_.\+\-]+
    { out(join(w)) }

</textarea>

<textarea id=pad rows=5># command

-01 +02.30 +4e-5  \ numbers
0xDeadBeef 0b1101 \ machine

</textarea>

</div>

<button id=go onclick="go()">GO</button>
</div>

<script src=PEG.js></script>
<script src=SYM.js></script>
<script>

/// parser helpers

function join(dat) { return dat.join("") }

function num(s,n,f,e) {
	var N = ''
	if (s) N += s					// [s]ign prefix
	N += join(n)					// i[n]teger part
	if (f) N += '.'+join(f)			// [f]loat part
	if (e) N += join(e)				// [e]xponential part
	if (!f & !e) return new Int(N)
	else		 return new Num(N)
}

function wrap(some) {
	var S = '' 
	JSON.stringify(some)
		.match(/.{1,44}/g)
		.forEach(function(item,i,arr) {
			S += item + '\n'})
	return S	
}

function out(some) { log.innerText += wrap(some) }

function go() {
	log.innerText = ''
	try { peg.generate(meta.value).parse(pad.value) }
	catch(e) { log.innerText = "error:\n" + out(e) }
	update()
}

function keydown(event) {
	if (event.ctrlKey & event.key == 'Enter') go()
}

window.onload = function() {
	document.body.onkeydown = keydown
	update()
}

S = new Stack('data')

function push(obj) { S.push(obj) }

function update() {
	stack.innerText = S.head()
}

</script>
